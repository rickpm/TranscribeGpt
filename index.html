<!DOCTYPE html>
<html>
  <head>
    <title>Ask me a question</title>
    <link rel="stylesheet" href="/styles.css">
  </head>

  <body>
    <br>
    <h1>Ask me a Question</h1>
    <br>
    <button id="recButton" class="notRec">Start Recording</button>
    <p id="transcript"></p>
    <br>
    <div id="responseContainer">
      <div id="loader" class="hidden"></div>
      <p id="loadingText" class="hidden">Processing...</p>
      <p id="resultText"></p>
    </div>
  
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      let recorder;
      let audioStream;
  
      function enableMicrophone() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then(function (stream) {
            audioStream = stream;
            startRecording();
          })
          .catch(function (err) {
            console.error("Error enabling microphone", err);
          });
      }
  
      function startRecording() {
        recorder = new RecordRTC(audioStream, {
          type: "audio",
          recorderType: RecordRTC.StereoAudioRecorder,
          numberOfAudioChannels: 2,
        });
        recorder.startRecording();
        $('#recButton').addClass("Rec");
        document.getElementById("recButton").innerHTML = "Click again to stop";
        $('#loader').removeClass('hidden');
        $('#loadingText').removeClass('hidden');
        setTimeout(stopRecording, 60000); // Stop recording after 1 minute
      }
  
      function stopRecording() {
        recorder.stopRecording(function () {
          let blob = recorder.getBlob();
          uploadToS3(blob);
          recorder.reset();
          $('#recButton').removeClass("Rec");
          $('#recButton').addClass("notRec");
          $('#recButton').text("Start Recording");
          $('#loader').removeClass('hidden'); // Show the loader when recording stops
        });
      }
  
      function uploadToS3(blob) {
        const fileName = "audio" + Date.now() + ".wav";
        const formData = new FormData();
        formData.append("file", blob, fileName);
  
        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then(function (response) {
            waitForTranscriptResult(fileName);
          })
          .catch(function (error) {
            console.error("Error uploading file", error);
          });
      }
  
      function waitForTranscriptResult(
        fileName,
        retries = 20,
        interval = 3000
      ) {
        const transcriptFileName = fileName.replace(".wav", ".txt");
        const url = "/transcripts/" + transcriptFileName;
      
        let retryCount = 0;
      
        const fetchTranscript = () => {
          fetch(url)
            .then(function (response) {
              if (response.ok) {
                return response.text();
              } else {
                throw new Error("Network response was not OK");
              }
            })
            .then((result) => {
              const cleanURL = extractURLWithoutQueryParams(result);
              getTranscriptData(cleanURL);
            })
            .catch((error) => {
              console.error("Error checking transcript: ", error);
      
              retryCount++;
              if (retryCount < retries) {
                setTimeout(fetchTranscript, interval);
              } else {
                console.error("Maximum retries reached. Unable to fetch transcript.");
              }
            });
        };
      
        setTimeout(fetchTranscript, 5000); // Delay the execution of fetchTranscript by 10 seconds
      }
      
      
      function getTranscriptData(transcriptURL) {
        let retryCount = 0;
      
        const fetchData = () => {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", transcriptURL, true);
          xhr.onreadystatechange = function () {
            try {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  var transcriptText = xhr.responseText;
                  displayTranscript(transcriptText);
                  sendToChatGPT(transcriptText);
                } else {
                  throw new Error("Request failed with status " + xhr.status);
                }
              }
            } catch (error) {
              console.error("Error processing transcript request:", error);
              retryCount++;
              if (retryCount < 20) {
                console.log("Retrying in 10 seconds...");
                setTimeout(fetchData, 2000); // Retry after 2 seconds
              } else {
                console.error("Maximum retries reached. Unable to fetch transcript.");
              }
            }
          };
          xhr.send();
        };
      
        fetchData();
      }
      
      function displayTranscript(text) {
        var transcriptDiv = document.getElementById("transcript");
        transcriptDiv.textContent = text;
      }
      
      function extractURLWithoutQueryParams(url) {
        const index = url.indexOf("?");
        if (index !== -1) {
          return url.substring(0, index);
        }
        return url;
      }
      
      function sendToChatGPT(transcript) {
        $('#loader').addClass('hidden');
        $('#loadingText').addClass('hidden');
        $('#stopLoader').removeClass('hidden'); // Show the stop loader when sending the transcript to ChatGPT
        const prompt = transcript;
        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ prompt }),
        })
          .then((response) => response.json())
          .then((data) => {
            const generatedResponse = data.response;
            const responseContainer = document.querySelector("#responseContainer");
            const resultText = document.getElementById('resultText');
      
            if (resultText) {
              resultText.textContent = generatedResponse;
            }
      
            if (responseContainer) {
              responseContainer.innerHTML = `<p>${generatedResponse}</p>`;
            }
      
            $('#stopLoader').addClass('hidden'); // Hide the stop loader when the answer is displayed
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      
        // Update the button text
        $('#recButton').text("Start Recording");
      }
      
      function resetScreen() {
        const transcriptDiv = document.getElementById("transcript");
        transcriptDiv.textContent = "";
        const responseContainer = document.getElementById("responseContainer");
        responseContainer.innerHTML = "";
        $('#stopLoader').addClass('hidden'); // Hide the stop loader when resetting the screen
      }
      
      $(document).ready(function () {
        $('#recButton').click(function () {
          if ($('#recButton').hasClass('notRec')) {
            $('#recButton').removeClass("notRec");
            $('#recButton').addClass("Rec");
            $('#loader').removeClass('hidden');
            $('#loadingText').removeClass('hidden');
            enableMicrophone();
          } else {
            $('#recButton').removeClass("Rec");
            $('#recButton').addClass("notRec");
            $('#loader').removeClass('hidden');
            $('#loadingText').removeClass('hidden');
            stopRecording();
            resetScreen();
          }
        });
      });
      </script>
      </body>
      </html>
      